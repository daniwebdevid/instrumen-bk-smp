---
import BaseLayout from '../layouts/BaseLayout.astro';
import InputIdentitas from '../components/InputIdentitas.astro';
import LikertTable from '../components/LikertTable.astro';
import InputJawabanSingkat from '../components/InputJawabanSingkat.astro';

// PENTING: GANTI DENGAN URL GAS ASLI KAMU SETELAH DEPLOY!
// Format harus: https://script.google.com/macros/s/AKfycb.../exec
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby_uGsE1Qmfri1gGh8j_l3gSIgxKV-Zw5Vr0ZIyGsE8EHi9J-Ho2EWMffbulO1pbPomhQ/exec'; 

// Data untuk Tabel Likert (Q1 - Q12)
const likertData = [
  { id: 'Q1', text: 'Saya merasa khawatir tentang masa depan saya.' },
  { id: 'Q2', text: 'Saya kesulitan fokus saat belajar atau melakukan tugas.' },
  { id: 'Q3', text: 'Saya sering merasa sedih tanpa alasan yang jelas.' },
  { id: 'Q4', text: 'Saya merasa tidak punya teman yang bisa dipercaya.' },
  { id: 'Q5', text: 'Saya merasa tekanan dari orang tua atau guru untuk berprestasi.' },
  { id: 'Q6', text: 'Saya merasa takut saat berbicara di depan kelas.' },
  { id: 'Q7', text: 'Saya kesulitan mengelola waktu antara belajar dan kegiatan lain.' },
  { id: 'Q8', text: 'Saya pernah ingin bolos atau menghindari sekolah.' },
  { id: 'Q9', text: 'Saya merasa kurang percaya diri dengan penampilan saya.' },
  { id: 'Q10', text: 'Saya sering menunda pekerjaan sampai menit terakhir.' },
  { id: 'Q11', text: 'Saya khawatir tentang konflik atau masalah di rumah.' },
  { id: 'Q12', text: 'Saya tidak tahu apa yang ingin saya lakukan setelah lulus.' },
];

// Data untuk Jawaban Singkat (Q13 - Q24) - Digunakan untuk looping komponen InputJawabanSingkat
const essayData = [
    { nomor: '13', id_name: 'Q13', soal: 'Apa hal yang paling membuat kamu cemas atau khawatir saat ini?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '14', id_name: 'Q14', soal: 'Tuliskan satu tujuan yang ingin kamu capai di semester ini.', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '15', id_name: 'Q15', soal: 'Bagaimana cara kamu menghadapi saat merasa sangat marah atau frustasi?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '16', id_name: 'Q16', soal: 'Siapa orang yang paling kamu percaya di sekolah (selain guru) dan mengapa?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '17', id_name: 'Q17', soal: 'Jelaskan kesulitan terbesar kamu dalam belajar mata pelajaran tertentu.', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '18', id_name: 'Q18', soal: 'Apa kegiatan di luar sekolah (hobi/ekskul) yang paling kamu nikmati?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '19', id_name: 'Q19', soal: 'Bagaimana hubunganmu dengan teman sebaya di kelas?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '20', id_name: 'Q20', soal: 'Apa yang kamu harapkan dari layanan Bimbingan dan Konseling di sekolah?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '21', id_name: 'Q21', soal: 'Apa satu hal yang ingin kamu ubah dari dirimu sendiri?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '22', id_name: 'Q22', soal: 'Apa yang akan kamu lakukan jika kamu melihat temanmu dibully?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '23', id_name: 'Q23', soal: 'Hal apa yang paling kamu syukuri dalam hidupmu saat ini?', placeholder: 'Tuliskan jawabanmu di sini...' },
    { nomor: '24', id_name: 'Q24', soal: 'Pesan apa yang ingin kamu sampaikan kepada Guru BK-mu?', placeholder: 'Tuliskan jawabanmu di sini...' },
];

---

<BaseLayout title="Instrumen Kebutuhan Siswa">
  <div class="container my-5">
    
    <header class="text-center mb-5">
      <h1 class="display-6 fw-bold text-primary">Instrumen Kebutuhan Layanan Siswa</h1>
      <p class="lead text-muted">Aplikasi ini dirancang untuk memetakan kebutuhan akademik, pribadi, dan sosial siswa untuk layanan Bimbingan dan Konseling.</p>
    </header>

    <form class="needs-validation" id="bk-form" novalidate>
      
      <div class="card shadow-sm mb-5 p-4 border-0">
        <h2 class="fs-5 fw-bold text-dark mb-4 border-start border-4 border-dark ps-3">
          0. Data Identitas
        </h2>
        <InputIdentitas />
      </div>

      <div class="card shadow-sm mb-5 p-4 border-0">
        <h2 class="fs-5 fw-bold text-primary mb-2 border-start border-4 border-primary ps-3">
            1. Skala Kebutuhan Cepat (Q1 - Q12)
        </h2>
        <p class="small text-muted mb-4">
            Pilih jawaban yang paling sesuai dengan kondisimu dalam 30 hari terakhir. 
            **1: Tidak Pernah, 2: Jarang, 3: Sering, 4: Selalu.**
        </p>
        <LikertTable questions={likertData} /> 
      </div>

      <div class="card shadow-sm mb-5 p-4 border-0">
        <h2 class="fs-5 fw-bold text-success mb-4 border-start border-4 border-success ps-3">
          2. Jawaban Singkat dan Reflektif (Q13 - Q24) <span class="small text-danger fw-normal fw-bold">(Wajib Diisi)</span>
        </h2>
        
        {/* Looping untuk memanggil komponen InputJawabanSingkat 12 kali */}
        {essayData.map((data) => (
            <InputJawabanSingkat
                nomor={data.nomor}
                soal={data.soal}
                id_name={data.id_name}
                placeholder={data.placeholder}
            />
        ))}

      </div>

      <div class="d-grid gap-2 mb-4">
        <button class="btn btn-primary btn-lg" type="submit" id="submit-btn">
          <span id="btn-text">Kirim Jawaban</span>
          <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        </button>
      </div>

      <div id="feedback-message" class="alert d-none" role="alert"></div>

      <footer class="mt-5 border-top py-3">
          <div class="container text-center small text-muted">
              &copy; {new Date().getFullYear()} Aplikasi instrumen kebutuhan layanan siswa. 
              Ditenagai oleh Astro & Bootstrap. Dibuat oleh <strong>DanyDev</strong>.
          </div>
      </footer>

    </form>
  </div>

  <script is:inline>
    // Pastikan ini adalah URL GAS yang BENAR (sudah di-deploy)
Ho2EWMffbulO1pbPomhQ/exec 
    const form = document.getElementById('    const gasUrl = "https://script.google.com/macros/s/AKfycby_uGsE1Qmfri1gGh8j_l3gSIgxKV-Zw5Vr0ZIyGsE8EHi9J-bk-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const spinner = document.getElementById('spinner');
    const feedbackMessage = document.getElementById('feedback-message');
    
    // Fungsi untuk menampilkan pesan feedback
    function showFeedback(type, message) {
        feedbackMessage.classList.remove('d-none', 'alert-success', 'alert-danger');
        feedbackMessage.classList.add(`alert-${type}`);
        feedbackMessage.textContent = message;
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validasi Bootstrap
        if (!form.checkValidity()) {
            e.stopPropagation();
            form.classList.add('was-validated');
            return;
        }

        // Kumpulkan data formulir
        const formData = {};
        const elements = form.elements;
        for (let i = 0; i < elements.length; i++) {
            const el = elements[i];
            if (el.name && (el.type !== 'radio' || el.checked) && el.type !== 'submit') {
                formData[el.name] = el.value;
            }
        }
        
        // Tampilkan spinner dan nonaktifkan tombol
        submitBtn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'inline-block';
        feedbackMessage.classList.add('d-none'); // Sembunyikan pesan lama

        try {
            // --- PERBAIKAN CORS (Mengubah JSON ke URLSearchParams) ---
            // 1. Konversi objek JSON menjadi URLSearchParams
            const params = new URLSearchParams();
            for (const key in formData) {
                params.append(key, formData[key]); 
            }

            // 2. Kirim data sebagai string/text, TANPA header JSON
            const response = await fetch(gasUrl, {
                method: 'POST',
                // Hapus headers: {'Content-Type': 'application/json'}
                body: params.toString() 
            });

            // Pastikan kita bisa membaca respons JSON dari GAS
            const result = await response.json(); 

            if (response.ok && result.status === 'success') {
                showFeedback('success', result.message || 'Data berhasil dikirim! Terima kasih.');
                form.reset();
                form.classList.remove('was-validated'); // Hapus validasi setelah sukses
            } else {
                // Tangani respons error dari GAS
                showFeedback('danger', result.message || 'Gagal mengirim data. Silakan coba lagi.');
            }

        } catch (error) {
            console.error("Error saat mengirim:", error);
            showFeedback('danger', 'Terjadi kesalahan jaringan. Mohon cek URL GAS Anda atau hubungi admin.');
        } finally {
            // Aktifkan kembali tombol
            submitBtn.disabled = false;
            btnText.style.display = 'inline';
            spinner.style.display = 'none';
        }
    });
</script>
</BaseLayout>